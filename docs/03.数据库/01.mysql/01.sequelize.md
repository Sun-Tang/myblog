---
title: sequelize
date: 2023-04-17 21:11:31
permalink: /pages/35e430/
categories:
  - 数据库
  - mysql
tags:
  -
---

## ORM 框架-Sequelize

### 1. 初始化测试 node 项目

#### 基础初始化

```shell
mkdir testNode  // 创建文件夹

cd testNode     // 进入文件夹

npm init -y     // 初始化 npm

mkdir app.js	// 创建 node 项目启动根目录
```

#### 配置 app.js 页面

```javascript
const express = require('express');
const app = express();
const cors = require('cors');
const Account = require('./models/Account');

app.use(cors());

app.get('/account', async (req, res) => {
  await Account.create({ username: '老六', age: 30, hobby: '发呆' });
  res.send('插入成功');
});

app.listen(8081, () => {
  console.log('服务启动在: http://127.0.0.1:8081');
});
```

#### 启动 node 项目

- 安装热更新启动库

```shell
npm i -g nodemon
```

- 启动方式

```javascript
node app.js    // 普通启动

nodemon app.js  // 热更新启动
```

#### 安装数据库操作依赖

Sequelize 官网: https://www.sequelize.cn/core-concepts/getting-started

安装 sequelize

```sh
yarn add sequelize@6.24.0
```

安装 mysql 数据库安装驱动程序

```sh
yarn add mysql2@2.3.3
```

### 2. 链接数据库

#### 创建 confi/sequelize.js 文件，链接数据库

```javascript
const { Sequelize } = require('sequelize');

// database 数据库名字
// username 用户名
// password 密码
// host 数据库运行的服务器ip地址
// dialect 数据库类型
const sequelize = new Sequelize('test', 'root', 'xxxx', {
  host: 'xxxx',
  dialect: 'mysql'
});

module.exports = sequelize;
```

#### 测试连接

```javascript
const { Sequelize } = require('sequelize');

// database 数据库名字
// username 用户名
// password 密码
// host 数据库运行的服务器ip地址
// dialect 数据库类型
const sequelize = new Sequelize('test', 'root', '15468381.tan', {
  host: '159.75.253.154',
  dialect: 'mysql'
});

// 测试链接
(async function() {
  try {
    await sequelize.authenticate();
    console.log('数据库链接成功');
  } catch (error) {
    console.error('数据库链接失败:', error);
  }
})();

module.exports = sequelize;
```

#### 运行命令测试连接

根目录下运行以下指令：

```sh
node config/sequelize.js
```

### 3. 数据库模型具体操作

#### 定义模型

model/Account.js

```javascript
const { Sequelize, DataTypes } = require('sequelize');
const sequelize = require('../config/sequelize.js');

const Account = sequelize.define(
  'Account',
  {
    // 在这里定义模型属性
    id: {
      autoIncrement: true,
      type: DataTypes.BIGINT,
      allowNull: false,
      primaryKey: true
    },
    username: {
      type: DataTypes.STRING(255),
      allowNull: true,
      comment: '名字'
    },
    age: {
      type: DataTypes.BIGINT,
      allowNull: true,
      comment: '年龄'
    },
    hobby: {
      type: DataTypes.STRING(255),

      allowNull: true,
      comment: '爱好'
    },
    gmt_create: {
      type: DataTypes.DATE,
      allowNull: true,
      defaultValue: Sequelize.Sequelize.literal('CURRENT_TIMESTAMP'),
      comment: '创建时间'
    },
    gmt_modified: {
      type: DataTypes.DATE,
      allowNull: true,
      defaultValue: Sequelize.Sequelize.literal('CURRENT_TIMESTAMP')
    }
  },
  {
    tableName: 'account',
    timestamps: false
    // 其他模型参数
  }
);

(async () => {
  await Account.sync({ alter: true });
  console.log('成功同步');
})();

module.exports = Account;
```

#### 模型同步

- 实现方案

```javascript
Account.sync() - 如果表不存在, 则创建该表, 否则, 不执行任何操作;

Account.sync({ force: true }) - 将创建表, 如果表已经存在, 则将其首先删除;

Account.sync({ alter: true }) - 这将检查数据库中表的数据,
  然后在表中进行必要的更改以使其与模型匹配;
```

- 具体代码

```javascript
(async () => {
  await Account.sync({ alter: true });
  console.log('成功同步');
})();
```

- 执行命令测试是否成功：

```shell
node model/Account.js
```

#### 简单的 INSERT 操作

- 实现方法

```javascript
app.get('/account', async (req, res) => {
  await Account.create({ username: '老六', age: 30, hobby: '发呆' });
  res.send('插入成功');
});
```

- 具体测试

app.js 文件内

```javascript
const express = require('express');
const app = express();
const cors = require('cors');
const Account = require('./models/Account');

app.use(cors());

app.get('/account', async (req, res) => {
  await Account.create({ username: '老六', age: 30, hobby: '发呆' });
  res.send('插入成功');
});

app.listen(8081, () => {
  console.log('服务启动在: http://127.0.0.1:8081');
});
```

- 测试接口操作是否成功

postman 请求 get 方法

```javascript
http://127.0.0.1:8081/account
```
